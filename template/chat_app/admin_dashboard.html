<div id="notifier" style="display:none; margin-bottom:10px; font-weight:bold;"></div>

<div class="chat-box" id="messages-container">
    {% for msg in messages %}
        <div class="message {% if msg.is_from_admin %}admin{% else %}user{% endif %}">
            <b>{% if msg.is_from_admin %}Ø§Ø¯Ù…ÛŒÙ†{% else %}Ú©Ø§Ø±Ø¨Ø±{% endif %}</b> (Ú†Øªâ€ŒØ±ÙˆÙ…: {{ msg.chat_room }}):
            {{ msg.text }}
        </div>
    {% empty %}
        <p>Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
    {% endfor %}
</div>

<script>
    const originalTitle = document.title;
    let notificationInterval = null;
    let lastUpdateTime = 0;
    const updateFrequency = 5000; // 10 Ø«Ø§Ù†ÛŒÙ‡

    // Ù…Ø¯ÛŒØ±ÛŒØª Ú†Ø´Ù…Ú© Ø²Ø¯Ù† Ø¹Ù†ÙˆØ§Ù†
    function startNotificationBlink(type) {
        stopNotificationBlink();
        let visible = true;
        const icons = { 'chatroom': 'ğŸ”µ', 'message': 'ğŸŸ ' };

        notificationInterval = setInterval(() => {
            document.title = visible ?
                `${icons[type]} ${type === 'chatroom' ? 'Ú†Øª Ø±ÙˆÙ… Ø¬Ø¯ÛŒØ¯!' : 'Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯!'}` :
                originalTitle;
            visible = !visible;
        }, 1000);
    }

    function stopNotificationBlink() {
        if (notificationInterval) {
            clearInterval(notificationInterval);
            notificationInterval = null;
            document.title = originalTitle;
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
    function showNotification(chatrooms, messages) {
        const notifier = document.getElementById('notifier');

        if (chatrooms > 0) {
            notifier.innerHTML = `ğŸ§‘â€ğŸ’¬ ${chatrooms} Ú†Øª Ø¬Ø¯ÛŒØ¯`;
            notifier.style.display = 'block';
            startNotificationBlink('chatroom');
        }
        else if (messages > 0) {
            notifier.innerHTML = `ğŸ“© ${messages} Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯`;
            notifier.style.display = 'block';
            startNotificationBlink('message');
        }
        else {
            notifier.style.display = 'none';
            stopNotificationBlink();
        }
    }

    // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ø´ Ú©Ø±Ø¯Ù†
    async function fetchMessages(forceUpdate = false) {
        const now = Date.now();
        if (!forceUpdate && now - lastUpdateTime < updateFrequency) return;

        try {
            const response = await fetch(`/chat/api/messages/?t=${now}`);
            const data = await response.json();
            const container = document.getElementById('messages-container');

            if (data.messages?.length > 0) {
                container.innerHTML = data.messages.map(msg => `
                    <div class="message ${msg.is_from_admin ? 'admin' : 'user'}">
                        <b>${msg.is_from_admin ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ú©Ø§Ø±Ø¨Ø±'}</b>
                        (Ú†Øªâ€ŒØ±ÙˆÙ…: ${msg.chat_room || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}): ${msg.text}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p>Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
            }

            lastUpdateTime = now;
        } catch (e) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:', e);
        }
    }

    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ÛŒ
    async function checkNewChatData(forceUpdate = false) {
        const now = Date.now();
        if (!forceUpdate && now - lastUpdateTime < updateFrequency) return;

        try {
            const response = await fetch(`/chat/api/unseen-data/?t=${now}`);
            const data = await response.json();
            showNotification(data.new_chatrooms, data.new_messages);
            lastUpdateTime = now;
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ú†Øª:", error);
        }
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
    async function update(force = false) {
        await Promise.all([
            fetchMessages(force),
            checkNewChatData(force)
        ]);
    }

    // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ…Ø± Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
    const updateInterval = setInterval(update, updateFrequency);

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ØµÙØ­Ù‡
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            update(true); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡
        }
    });

    window.addEventListener('focus', () => update(true));
    window.addEventListener('beforeunload', () => {
        clearInterval(updateInterval);
        stopNotificationBlink();
    });

    // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    update(true);
</script>